name: build and push
description: build a conan package and push it to artifactory
on:
  workflow_dispatch:
    inputs:

      package:
        description: 'package name'
        required: true
      version:
        description: 'package version'
        required: true
      
      conanfile_path:
        description: 'override conanfile.py path (auto-resolved from config.yml if empty)'
        required: false
        default: ''

      repository:
        description: 'Choose Artifactory repository'
        required: false
        type: choice
        options:
          - production
          - testing
        default: 'testing'

      user_channel:
        description: 'define the user and channel for the package '
        required: false
        default: ''
jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      CONAN_REVISIONS_ENABLED: 1
      PACKAGE_REF: ${{ github.event.inputs.package }}/${{ github.event.inputs.version }}@${{ github.event.inputs.user_channel }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Resolve conanfile path from config.yml
        id: resolve
        run: |
          PACKAGE="${{ github.event.inputs.package }}"
          VERSION="${{ github.event.inputs.version }}"
          OVERRIDE="${{ github.event.inputs.conanfile_path }}"

          if [ -n "$OVERRIDE" ]; then
            FOLDER=$(dirname "$OVERRIDE")
          else
            CONFIG="${PACKAGE}/config.yml"
            if [ ! -f "$CONFIG" ]; then
              echo "::error::config.yml not found at ${CONFIG}"
              exit 1
            fi
            FOLDER=$(python3 -c "
import yaml, sys
with open('${CONFIG}') as f:
    config = yaml.safe_load(f)
folder = config.get('versions', {}).get('${VERSION}', {}).get('folder')
if not folder:
    print(f'::error::version ${VERSION} not found in ${CONFIG}', file=sys.stderr)
    sys.exit(1)
print(folder)
")
          fi

          echo "recipe_path=${PACKAGE}/${FOLDER}/conanfile.py" >> "$GITHUB_OUTPUT"
          echo "Resolved recipe path: ${PACKAGE}/${FOLDER}/conanfile.py"

      - name: Install Conan
        run: |
          pip install --user conan==1.65.0 pyyaml
          conan --version

      - name: Configure Conan remote
        run: |
          conan remote remove conancenter
          conan remote add default-conan-local https://milvus01.jfrog.io/artifactory/api/conan/default-conan-local
          conan remote add testing https://milvus01.jfrog.io/artifactory/api/conan/testing

          # make conancenter the lowest priority
          conan remote add conancenter https://center.conan.io 

      - name: List remote Conan repositories
        run: |
          # List remote Conan repositories
          conan remote list

      - name: build a package
        run: |

          conan create ${{ steps.resolve.outputs.recipe_path }} $PACKAGE_REF \
            --build=missing \
            -s compiler=gcc \
            -s compiler.version=11 \
            -s compiler.libcxx=libstdc++11 \
            -s compiler.cppstd=17 \
            -s build_type=Release


      - name: inspect built package
        run: |
          conan search '*' --revisions

      - name: Upload
        run: |

          # upload all packages
          if [ "${{ github.event.inputs.repository }}" = "production" ]; then
            conan user -p ${{ secrets.JFROG_PASSWORD }} -r default-conan-local ${{ secrets.JFROG_USERNAME }}
            # upload to production repository
            conan upload '*' -r default-conan-local -c
          else
            conan user -p ${{ secrets.JFROG_PASSWORD }} -r testing ${{ secrets.JFROG_USERNAME }}
            # upload to testing repository
            conan upload '*' -r testing -c
          fi
