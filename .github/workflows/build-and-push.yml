name: build and push
description: build a conan package and push it to artifactory
on:
  workflow_dispatch:
    inputs:

      package:
        description: 'package name'
        required: true
      version:
        description: 'package version'
        required: true
      
      conanfile_path:
        description: 'the conanfile.py path of the package '
        required: true
        default: 'all/conanfile.py'

      repository:
        description: 'Choose Artifactory repository'
        required: false
        type: choice
        options:
          - production
          - testing
        default: 'testing'

      user_channel:
        description: 'define the user and channel for the package '
        required: false
        default: ''

      extra_options:
        description: 'extra conan options (e.g. -o pkg:opt=val -c conf=val)'
        required: false
        default: ''
jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      # the path of the conanfile.py
      PACKAGE_RECIPE_PATH: ${{ github.event.inputs.package }}/${{ github.event.inputs.conanfile_path }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.13' 

      - name: Install Conan
        run: |
          pip install --user conan==2.25.1
          conan --version
          conan profile detect

      - name: Configure Conan remote
        run: |
          conan remote add default-conan2-local https://milvus01.jfrog.io/artifactory/api/conan2/default-conan2-local --index 0
          conan remote add testing https://milvus01.jfrog.io/artifactory/api/conan2/testing --index 1
          # conancenter is added by default, keep it as lowest priority 

      - name: List remote Conan repositories
        run: |
          # List remote Conan repositories
          conan remote list

      - name: Export all local recipes
        run: |
          # Export all recipes in the repo so transitive deps can be resolved locally
          for config in */config.yml; do
            pkg_dir=$(dirname "$config")
            pkg_name=$(basename "$pkg_dir")
            recipe_path="$pkg_dir/all/conanfile.py"
            if [ -f "$recipe_path" ]; then
              # Read versions from config.yml and export each
              python3 -c "
          import yaml, sys
          with open('$config') as f:
              data = yaml.safe_load(f)
          for ver in (data.get('versions') or {}):
              print(ver)
          " | while read -r ver; do
                conan export "$recipe_path" "$pkg_name/$ver@" 2>/dev/null || true
              done
            fi
          done

      - name: build a package
        run: |
          USER_CHANNEL="${{ github.event.inputs.user_channel }}"
          USER_FLAGS=""
          if [ -n "$USER_CHANNEL" ]; then
            USER_FLAGS="--user=${USER_CHANNEL%%/*} --channel=${USER_CHANNEL#*/}"
          fi
          conan create $PACKAGE_RECIPE_PATH \
            --version=${{ github.event.inputs.version }} \
            $USER_FLAGS \
            --build=missing \
            -s compiler=gcc \
            -s compiler.version=11 \
            -s compiler.libcxx=libstdc++11 \
            -s compiler.cppstd=17 \
            -s build_type=Release \
            ${{ github.event.inputs.extra_options }}


      - name: inspect built package
        run: |
          conan list '*:*'

      - name: Upload
        run: |
          # upload all packages
          if [ "${{ github.event.inputs.repository }}" = "production" ]; then
            conan remote login default-conan2-local ${{ secrets.JFROG_USERNAME }} -p ${{ secrets.JFROG_PASSWORD }}
            # upload to production repository
            conan upload '*' -r default-conan2-local -c
          else
            conan remote login testing ${{ secrets.JFROG_USERNAME }} -p ${{ secrets.JFROG_PASSWORD }}
            # upload to testing repository
            conan upload '*' -r testing -c
          fi
